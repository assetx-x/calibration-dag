Flow {
    DataPull = [
        "TimelinePermutator"
        "SQLReaderPriceData"
        "SQLReaderAdjustmentFactors"
        "SQLReaderFundamentalDataQuandl"
        "SQLReaderRavenpackMomentumIndicator"
        "SQLReaderRavenpackOvernightVolume"
        "SQLReaderETFInformation"
        "SQLReaderEarningsDates"
        "SQLReaderSectorBenchmarkMap"
        "SQLReaderDailyIndexData"
    ]
    DerivedDataProcessing = [
        "CalibrationDatesFundamental"
        "CalculateVolatility"
        "CalculateDerivedFundamentalsQuandl"
        "CalculateRawEntryPriceOnIntervals"
        "CalculateTSI"
        "CalculateMACD"
        "CalcualteCorrelation"
        "CalculateTechnicalIndicator"
        "CalculateStochasticIndicatorEWMA"
        "CalculateStochasticIndicator"
        "CalculateDollarVolume"
        "CalculateOvernightReturn"
        "CalculatePerformanceReturnOnIntervals"
        "CalcualteQuarterlyReturn"
        "CalculatePastReturn"
        "CalculateSPYPeerRank"
        "CalculateTechnicalIndicatorComparisons"
    ]
    DataConsolidation = [
        "FundamentalsMergeQuandl"
        "FundamentalsDigitizationQuandl"
    ]
    RuleApplication = [
        "RulesReader"
        "RuleApplications"
        "FundamentalsAssetSelectorAndWeighting"
    ]
    Calibration = [
        "FundamentalsCalibration"
    ]
}
FlowConfiguration {
    snapshot_location = "/mnt/disk1/temp/pipeline_tests/fundamental"
    base_configuration_filepath = "../configuration/market_view_calibration_pipeline.conf"
    base_configuration_overrides {}
	use_existing_cache_for_stages = [*]
	calibration_mode_overrides {
		StepsConfiguration {
			FundamentalsCalibration : {
			   output_dir = ./processes/data_processing/calibrations/fundamental_rebalancing_trader/calibration_files/
			   file_suffix = "fundamental_rebalancing_trader.csv"
			   ignore_calibration_timeline = False
			}
		}
	}

	test_mode_overrides {
		FlowConfiguration {
			snapshot_location = "./test/test_run_cache"
		}
		StepsConfiguration {
			CalibrationDatesFundamental {
				cache_file: "../configuration/intervals_bms.csv"
				target_dt: "2018-11-01"
				intervals_start_dt: "2018-06-01"
				intervals_end_dt: "2018-11-01"
				force_recalculation: True
				save_intervals_to: null
			}
		}
	}

}
StepsConfiguration {
    TimelinePermutator {
		permutation_enabled = False
		timeline_segmenter_function_names = null
		random_seed = 12345
        permute_day_at_lowest_segment = True
	}
    SQLReaderPriceData {
        table_name = "daily_equity_prices"
		price_limit_filters = {open:[0, 1000000], close:[0, 100000]}
    }
    SQLReaderAdjustmentFactors {
        table_name = "equity_adjustment_factors"
    }
    SQLReaderFundamentalDataQuandl {
        table_name = "fundamental_data"
		date_column = "as_of_start"
    }
    SQLReaderRavenpackMomentumIndicator {
		ndays_slow = 91
		ndays_fast = 28
	}
    SQLReaderRavenpackOvernightVolume {}
    SQLReaderETFInformation {}
    SQLReaderEarningsDates {}
    SQLReaderSectorBenchmarkMap {}
    SQLReaderDailyIndexData {
        table_name = "daily_index"
		index_names = ["SPX", "PPUT", "CMBO", "BFLY", "RXM", "VIX", "VXST", "VXMT", "VIX3M"]
    }	CalculateVolatility: {
		volatility_lookback = 63
		price_column = close
	}
    CalibrationDatesFundamental {
	cache_file: "../configuration/intervals_bms.csv"
	target_dt: null
	intervals_start_dt: null
	intervals_end_dt: null
	force_recalculation: True
	save_intervals_to: null
    }
    CalculateRawEntryPriceOnIntervals {
        use_previous_close_as_entry = false
    }
    CalculateDerivedFundamentalsQuandl: {
	concept_filter: null
    }
	CalculateTSI: {
		technical_indicator = tsi,
		technical_indicator_params = {nslow:25, nfast:13, offset:1},
		smoothing_period = 3,
		price_column = close
	}
	CalculateMACD: {
		technical_indicator = macd,
		technical_indicator_params = {nslow:26, nfast:12},
		smoothing_period = 3,
		price_column = close
	}
	CalcualteCorrelation {
		benchmark_names = ["SPY", "VWO", "TLT", "GSG", "GLD"]
		correlation_lookback = 63
		price_column = open
	}
	CalculateTechnicalIndicator {
		technical_indicator = price_oscillator,
		technical_indicator_params = {nslow: 26, nfast: 12},
		price_column = close,
		calculate_indicator_ranking =True
	}
	CalculateStochasticIndicatorEWMA: {
		technical_indicator = stoch_k,
		technical_indicator_params = {offset: 22},
		smoothing_period = 5,
		smoothing_period_2 = 5,
		price_column = high
	}
	CalculateStochasticIndicator {
		technical_indicator = stoch_k
		technical_indicator_params = {offset: 14}
		smoothing_period = 3
		smoothing_period_2 = 3
		price_column = close
	}
	CalculateDollarVolume {
		lookback_periods = 10
	}
    CalculateOvernightReturn {}
	CalculatePerformanceReturnOnIntervals {
		addtive_tc = 0.01
		slippage_pct = 0.001
	}
    CalcualteQuarterlyReturn {}
	CalculatePastReturn: {
		column : close
		lookback_list : [20, 60, 125, 252]
	}
	CalculateSPYPeerRank {
		peer_tickers = [DIA, DVY, IJH, IJJ, IJK, IJR, IVE, IVV, IVW, IWB, IWD, IWM, IWN, IWO, IWR, IWV, MDY, RSP, SCHA, SPY, VTI, VTV, VV]
	}
	CalculateTechnicalIndicatorComparisons {
		pairs_to_compare = {DVY_VCIT: [DVY, VCIT], IWO_IJR: [IWO, IJR], SPY_EEM: [SPY, EEM], SPY_IWN: [SPY, IWN]}
	}
	FundamentalsMergeQuandl: {
		ranking_benchmarks = [DIA, DVY, IJH, IJJ, IJK, IJR, IVE, IVV, IVW, IWB, IWD, IWM, IWN, IWO, IWR, IWV, MDY, RSP, SCHA, SPY, VTI, VTV, VV]
		sector_benchmarks = [XLI, XLV, XLF, XLK, XLY, XLE, VDC, XLB, XLU]
		other_benchmarks = [TLT, RSP, EEM, ACWI]
		addtive_tc = null
		slippage_pct = null
	}
	FundamentalsDigitizationQuandl: {
		digitization_description = {
			per_date: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score, capex_arq, free_cash_flow_yield_arq, cash_return_arq,
						   shareholder_yield_arq, ebitda_to_ev_arq, gross_profit_to_assets_arq,
						   capex_art, free_cash_flow_yield_art, cash_return_art,
						   shareholder_yield_art, ebitda_to_ev_art, gross_profit_to_assets_art,
						   gross_margin_art, net_margin_art, free_cash_flow_to_assets_art, asset_turnover_art, marketcap,
						   enterprise_value_arq, enterprise_value_art,
						   eps_arq, eps_diluted_arq, ev_to_ebit_art, ev_to_ebitda_art, pe_ratio_art, price_to_book_arq,
						   debt_to_equity_arq, debt_to_assets_arq, total_asset_yield_arq, total_debt_yield_arq,
						   debt_issuance_yield_arq, share_repurchase_yield_arq, net_cash_flow_yield_arq,
						   net_operating_cash_flow_yield_arq,
						   debt_to_equity_art, debt_to_assets_art, total_asset_yield_art, total_debt_yield_art,
						   debt_issuance_yield_art, share_repurchase_yield_art, net_cash_flow_yield_art,
						   net_operating_cash_flow_yield_art,
						   payout_ratio_arq, payout_ratio_art, ros_art, pe_ratio_damodaran_art, price_to_sales_art,
						   price_to_sales_damodaran_art, tangible_book_value_per_share_arq,
						   tangible_book_value_per_share_art, book_value_per_share_arq, book_value_per_share_art,
						   tangible_asset_arq, tangible_asset_art,
						   inventory_ratio_art, inventory_ratio_arq, gearing_ratio_art, gearing_ratio_arq,
						   fcf_to_tangible_assets_art, fcf_to_tangible_assets_arq, roe_roic_zcombined,
						   pb_roe_art_zcombined, pb_gpa_zcombined, fcf_cash_yield_zcombined,
						   fcf_cash_shareholder_yield_zcombined, fcf_gpa_zcombined, shareholder_yield_gpa_zcombined,
						   cash_return_gpa_zcombined, fcfy_test, fcf_yield,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
				group_by = [entry_date]
				suffix = _date
			},
			per_sector_date: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score, capex_arq, free_cash_flow_yield_arq, cash_return_arq,
						   shareholder_yield_arq, ebitda_to_ev_arq, gross_profit_to_assets_arq,
						   capex_art, free_cash_flow_yield_art, cash_return_art,
						   shareholder_yield_art, ebitda_to_ev_art, gross_profit_to_assets_art,
						   gross_margin_art, net_margin_art, free_cash_flow_to_assets_art, asset_turnover_art, marketcap,
						   enterprise_value_arq, enterprise_value_art,
						   eps_arq, eps_diluted_arq, ev_to_ebit_art, ev_to_ebitda_art, pe_ratio_art, price_to_book_arq,
						   debt_to_equity_arq, debt_to_assets_arq, total_asset_yield_arq, total_debt_yield_arq,
						   debt_issuance_yield_arq, share_repurchase_yield_arq, net_cash_flow_yield_arq,
						   net_operating_cash_flow_yield_arq,
						   debt_to_equity_art, debt_to_assets_art, total_asset_yield_art, total_debt_yield_art,
						   debt_issuance_yield_art, share_repurchase_yield_art, net_cash_flow_yield_art,
						   net_operating_cash_flow_yield_art,
						   payout_ratio_arq, payout_ratio_art, ros_art, pe_ratio_damodaran_art, price_to_sales_art,
						   price_to_sales_damodaran_art, tangible_book_value_per_share_arq,
						   tangible_book_value_per_share_art, book_value_per_share_arq, book_value_per_share_art,
						   tangible_asset_arq, tangible_asset_art,
						   inventory_ratio_art, inventory_ratio_arq, gearing_ratio_art, gearing_ratio_arq,
						   fcf_to_tangible_assets_art, fcf_to_tangible_assets_arq, roe_roic_zcombined,
						   pb_roe_art_zcombined, pb_gpa_zcombined, fcf_cash_yield_zcombined,
						   fcf_cash_shareholder_yield_zcombined, fcf_gpa_zcombined, shareholder_yield_gpa_zcombined,
						   cash_return_gpa_zcombined, fcfy_test, fcf_yield,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.05, 0.10, 0.20, 0.5, 0.80, 0.90, 0.95, 1.0]
				group_by = [sector, entry_date]
				suffix = _sector_date
			},
			per_sector_date_decile: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score, capex_arq, free_cash_flow_yield_arq, cash_return_arq,
						   shareholder_yield_arq, ebitda_to_ev_arq, gross_profit_to_assets_arq,
						   capex_art, free_cash_flow_yield_art, cash_return_art,
						   shareholder_yield_art, ebitda_to_ev_art, gross_profit_to_assets_art,
						   gross_margin_art, net_margin_art, free_cash_flow_to_assets_art, asset_turnover_art, marketcap,
						   enterprise_value_arq, enterprise_value_art,
						   eps_arq, eps_diluted_arq, ev_to_ebit_art, ev_to_ebitda_art, pe_ratio_art, price_to_book_arq,
						   debt_to_equity_arq, debt_to_assets_arq, total_asset_yield_arq, total_debt_yield_arq,
						   debt_issuance_yield_arq, share_repurchase_yield_arq, net_cash_flow_yield_arq,
						   net_operating_cash_flow_yield_arq,
						   debt_to_equity_art, debt_to_assets_art, total_asset_yield_art, total_debt_yield_art,
						   debt_issuance_yield_art, share_repurchase_yield_art, net_cash_flow_yield_art,
						   net_operating_cash_flow_yield_art,
						   payout_ratio_arq, payout_ratio_art, ros_art, pe_ratio_damodaran_art, price_to_sales_art,
						   price_to_sales_damodaran_art, tangible_book_value_per_share_arq,
						   tangible_book_value_per_share_art, book_value_per_share_arq, book_value_per_share_art,
						   tangible_asset_arq, tangible_asset_art,
						   inventory_ratio_art, inventory_ratio_arq, gearing_ratio_art, gearing_ratio_arq,
						   fcf_to_tangible_assets_art, fcf_to_tangible_assets_arq, roe_roic_zcombined,
						   pb_roe_art_zcombined, pb_gpa_zcombined, fcf_cash_yield_zcombined,
						   fcf_cash_shareholder_yield_zcombined, fcf_gpa_zcombined, shareholder_yield_gpa_zcombined,
						   cash_return_gpa_zcombined, fcfy_test, fcf_yield,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
				group_by = [sector, entry_date]
				suffix = _sector_date_decile
			},
			per_date_quintiles: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.2, 0.4, 0.6, 0.8, 1.0]
				group_by = [entry_date]
				suffix = _date_quintile
			},
			per_sector_date_quintiles: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.2, 0.4, 0.6, 0.8, 1.0]
				group_by = [sector, entry_date]
				suffix = _sector_date_quintile
			},
			per_date_sextiles: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.167, 0.333, 0.5, 0.667, 0.833, 1.0]
				group_by = [entry_date]
				suffix = _date_sextile
			},
			per_sector_date_sextiles: {
				columns = [ret_20B, ret_60B, ret_125B, ret_252B, indicator, stoch_k, stoch_d, slow_stoch_d, stoch_k_d,
						   stoch_k_ewma, stoch_d_ewma, slow_stoch_d_ewma, stoch_k_d_ewma, q1, q2, q3, q4,
						   tsi, tsi_ma, macd, macd_centerline, macd_diff,
						   ret_20B_diff_ret_60B, ret_20B_diff_ret_125B, ret_20B_diff_ret_252B, ret_60B_diff_ret_125B,
						   ret_60B_diff_ret_252B,
						   sentiment_oscilator, sentiment_score,
						   SPY_correl, TLT_correl, GSG_correl, GLD_correl, VWO_correl, avg_dollar_volume, volatility_63]
				quantiles = [0.0, 0.167, 0.333, 0.5, 0.667, 0.833, 1.0]
				group_by = [sector, entry_date]
				suffix = _sector_date_sextile
			}
		}
	}
    RulesReader {
        rule_set = null
		ruleset_location = ["..", "fundamental_rebalancing_trader", "features_rules", "*.conf"]
    }
    RuleApplications {
        block_rules = null
        rule_organization_level = 2
        include_runtime_filters = false
    }
	FundamentalsAssetSelectorAndWeighting =
	{
		rule_dependencies = ["long_rules.long_rule_combined",
							 "short_rules.short_rule_combined"]
		sub_rule_params =
		{
			long_rules.long_rule_combined: {sort_columns: [ret_60B], ascending: [True], max_num: 60} # 50 # 60 # 60
			short_rules.short_rule_combined: {sort_columns: [ret_60B], ascending: [True], max_num: 50} # 30 # 45 #48 # 50
		}
		regime = 1
		exclude_tickers = [BIV, BSV, CHAD, IEF, IEI, LABD, QID, SDS, SH, SHY, SPXU, SQQQ, TIP, TLH, TLT', TVIX, TWM, TZA, UVXY, VIXY, VXX]
	}
	FundamentalsCalibration =
	{
		traders: {
			Fundamentals_FCFTrader_1: { # Fundamentals_FCFTrader_1 Fundamentals_FCFTrader_2
				ranking = 1
				long_rules = long_rules.long_rule_combined
				short_rules = short_rules.short_rule_combined
				hedge_ratio = 0.7
				stop_limits_pct = "(-0.4, 100.0)"
				basket_selloff_date = 2019-12-15
				rebalancing_frequency = BMS # BMS 4W-WED
				rebalancing_time = "09:31:00"
				leverage_ratio_per_trade = 1.5
			}
			#Fundamentals_FCFTrader_2: { # Fundamentals_FCFTrader_1 Fundamentals_FCFTrader_2
				#ranking = 1
				#long_rules = long_rules.long_rule_combined
				#short_rules = short_rules.short_rule_combined
				#hedge_ratio = 1.0 # 0.7
				#stop_limits_pct = "(-0.4, 100.0)"
				#basket_selloff_date = 2019-12-15
				#rebalancing_frequency = 4W-WED
				#rebalancing_time = "09:31:00"
				#leverage_ratio_per_trade = 1.5
			#}
		}
		supervisor: {
			total_funding = 9000000.0 # 9000000.0
			fundingRequestsAmount = 6350000.0 # 6350000.0 2120000.0
			funding_buffer = 250000.0
		}
		include_supervisor: True
		output_dir: "./calibration_files/"
		file_suffix: "fundamental_rebalancing_trader.csv"
		ignore_calibration_timeline = True
		calibration_date_offset = "BMS"
		calibration_anchor_date = null
	}
}
